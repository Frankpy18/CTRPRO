<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Asistente de ofrecimientos</title>
    <style>
        :root {
            --claro-red: #da291c;
            --dark-gray: #333;
            --light-gray: #f4f4f4;
            --highlight-bg: #ffebee;
            --highlight-text: #b71c1c;
        }
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:var(--light-gray);display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
        .container{background:white;padding:2.5rem;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.15);width:90%;max-width:780px;text-align:center;}
        h1{color:var(--dark-gray);margin-bottom:1.5rem;font-weight:700;}
        .screen{display:none;animation:slideIn 0.28s ease-out;}
        .screen.active{display:block;}
        .btn-big{display:block;width:100%;padding:20px;margin:12px 0;font-size:1.2rem;font-weight:800;color:white;background-color:var(--claro-red);border:none;border-radius:12px;cursor:pointer;text-transform:uppercase;box-shadow:0 4px 6px rgba(218,41,28,0.3);transition:all 0.18s;}
        .btn-big:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(218,41,28,0.35);}
        .btn-secondary{background-color:#757575;color:white;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;margin-top:18px;font-weight:700;}
        textarea.data-input{width:100%;height:120px;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-family:monospace;font-size:0.9rem;margin-bottom:16px;transition:border-color 0.25s;}
        textarea.data-input:focus{border-color:var(--claro-red);outline:none;box-shadow:0 6px 14px rgba(218,41,28,0.06);}
        .speech-container{margin-top:20px;text-align:left;position:relative;}
        .speech-box{background-color:white;border-left:6px solid var(--claro-red);padding:20px;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.06);font-size:1.05rem;line-height:1.6;color:#424242;}
        .dynamic-offer{font-weight:700;color:var(--claro-red);background-color:#fff3f3;padding:0 6px;border-radius:4px;}
        .speech-title{font-size:0.85rem;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:10px;display:block;font-weight:700;}
        .tags-container{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;}
        .tag{background:#f5f5f5;color:#555;padding:5px 10px;border-radius:6px;font-size:0.78rem;border:1px solid #eee;}
        @keyframes slideIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
        /* Responsive */
        @media (max-width:520px){
            .btn-big{padding:16px;font-size:1.05rem;}
            .container{padding:18px;}
        }
    </style>
</head>
<body>
<div class="container">
    <div id="screen-home" class="screen active">
        <h1>Seleccione Perfil</h1>
        <button class="btn-big" onclick="showScreen('titular')">TITULAR</button>
        <button class="btn-big" onclick="showScreen('usuario')">USUARIO</button>
    </div>

    <div id="screen-titular" class="screen">
        <h2>Perfil: TITULAR</h2>
        <textarea id="inputData" class="data-input" placeholder="Pegue aquí la data del cliente (ej: 'Cliente calificado para Actualización de Internet a Fibra Óptica; Cliente en campaña Cambio de Plan Fija', etc.)"></textarea>
        <button class="btn-big" onclick="generarSpeechTitular()">ANALIZAR OFERTA</button>

        <div id="output-titular" style="display:none;" class="speech-container">
            <span class="speech-title">Guion de Venta Sugerido:</span>
            <div class="speech-box"><p id="speech-text-titular"></p></div>
            <div class="tags-container" id="detected-tags"></div>
        </div>

        <button class="btn-secondary" onclick="showScreen('home')">Volver</button>
    </div>

    <div id="screen-usuario" class="screen">
        <h2>Perfil: USUARIO</h2>
        <div class="speech-container">
            <span class="speech-title">Guion de Venta Sugerido:</span>
            <div class="speech-box">
                <p id="speech-text-usuario">
                    "Sr/Sra ( nombre), le comento que usted también puede ser parte de la familia claro portando su línea movil a potspago, como tambien, con un chip prepago a 1 sol, que se le entregaría directamente a su domicilio. Para no dejar perder este beneficio y activarlo ahora mismo. ¿me confirma su dirección para poder gestionar la entrega de su promociòn?"
                </p>
            </div>
        </div>
        <button class="btn-secondary" onclick="showScreen('home')">Volver</button>
    </div>
</div>

<script>
/* ================== Definición de ofertas ================== */
const OFFER_DEFINITIONS = [
    { key: 'fibra', label: 'Actualización de Internet a Fibra Óptica', text: 'su migración a Fibra Óptica totalmente gratis', type: 'tech', requiresAddress: false },
    { key: 'fija', label: 'Cambio de Plan Fija', text: 'un cambio de plan fija con mejores canales y velocidad', type: 'service', requiresAddress: false },
    // Nota: la frase de renovación contiene un "y" interno; la lógica lo maneja para evitar repetir "y"
    { key: 'renovacion', label: 'Renovación postpago', text: 'la opción de renovar su equipo y plan', type: 'renewal', requiresAddress: false },
    { key: 'mig_prep_post', label: 'Migración de prepago a postpago', text: 'la posibilidad de migrar a postpago y obtener más beneficios', type: 'migration', requiresAddress: false }
];
const CHIP_HOOK = { key: 'chip', label: 'Chip S/1', text: 'un Chip prepago a solo S/1 con entrega a domicilio', type: 'chip', requiresAddress: true };

/* ================== Detección simple de keywords ================== */
function detectOffers(rawText) {
    const t = (rawText||'').toLowerCase();
    const detected = [];

    if (t.includes('fibra') || t.includes('fibra óptica') || t.includes('actualización de internet')) detected.push(OFFER_DEFINITIONS.find(o=>o.key==='fibra'));
    if (t.includes('cambio de plan fija') || t.includes('plan fija') || t.includes('claro tv') || t.includes('fija')) detected.push(OFFER_DEFINITIONS.find(o=>o.key==='fija'));
    if (t.includes('renovación postpago') || t.includes('renovacion postpago') || t.includes('renovar') || t.includes('renovación')) detected.push(OFFER_DEFINITIONS.find(o=>o.key==='renovacion'));
    if (t.includes('migración de prepago a postpago') || t.includes('migracion prepago') || t.includes('migrar a postpago') || t.includes('migración')) detected.push(OFFER_DEFINITIONS.find(o=>o.key==='mig_prep_post'));

    // eliminar duplicados y falsos
    return detected.filter(Boolean).reduce((acc, cur) => {
        if (!acc.find(a => a.key === cur.key)) acc.push(cur);
        return acc;
    }, []);
}

/* ================== Helpers de construcción ================== */
function capitalizeFirst(str){
    if(!str) return str;
    return str.charAt(0).toUpperCase() + str.slice(1);
}
function containsInternalY(text){
    // detecta un " y " con espacios para evitar coincidencias dentro de palabras
    return /\s+y\s+/i.test(text);
}

/* ================== Versión mejorada de buildSpeech ================== */
function buildSpeech(forProfile, detectedOffers) {
    // copiar ofertas detectadas
    const offers = [...detectedOffers.map(o=>({...o}))];

    // asegurarnos de que el chip siempre esté presente al final
    if (!offers.find(o=>o.key === CHIP_HOOK.key)) {
        offers.push({...CHIP_HOOK});
    }

    // extraer textos
    const texts = offers.map(o => o.text);

    // detectar si alguna oferta contiene " y " interno
    const anyInternalY = texts.some(t => containsInternalY(t));

    // construir cuerpo del mensaje evitando acumulación de "y"
    let body = '';
    if (texts.length === 1) {
        body = `${texts[0]}.`;
    } else if (texts.length === 2) {
        if (anyInternalY) {
            // separar en oraciones para mejor ritmo
            body = `${capitalizeFirst(texts[0])}. Además, ${texts[1]}.`;
        } else {
            body = `${texts[0]} y ${texts[1]}.`;
        }
    } else {
        // 3 o más: crear oraciones cortas para cada oferta excepto la última
        const firstSentences = texts.slice(0, -1).map(t => `${capitalizeFirst(t)}.`);
        const last = texts.slice(-1)[0];
        body = firstSentences.join(' ');
        // antes de la última, usar "Además," si alguna tenía ' y ' interno para mayor claridad
        body += ` ${anyInternalY ? 'Además, ' : ''}${last}.`;
    }

    // CTA: pedimos dirección si hay chip (porque se entrega físicamente)
    const includesChip = offers.some(o => o.key === CHIP_HOOK.key);
    let cta = '';
    if (includesChip) {
        cta = 'Para no dejar perder este beneficio y activarlo ahora mismo, ¿me confirma su dirección para poder gestionar la entrega de su promociòn?';
    } else {
        cta = 'Para no dejar perder este beneficio, ¿desea que lo active ahora?';
    }

    // Componer frase final según perfil
    if (forProfile === 'titular') {
        // mantener sujeto claro y directo
        return `Sr/Sra (nombre), le comento que tiene disponible ${body} <br><br> ${cta}`;
    } else {
        // usuario: speech fijo con portabilidad + chip
        return `Sr/Sra ( nombre), le comento que usted también puede ser parte de la familia claro, con ${CHIP_HOOK.text}. Además, tiene la opción de portar su número si lo desea. Para no dejar perder este beneficio y activarlo ahora mismo. ${cta}`;
    }
}

/* ================== Funciones UI y render ================== */
function showScreen(screenName) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    document.getElementById(`screen-${screenName}`).classList.add('active');

    if (screenName === 'titular') {
        document.getElementById('inputData').value = '';
        document.getElementById('output-titular').style.display = 'none';
    }
}

function generarSpeechTitular(){
    const rawText = document.getElementById('inputData').value || '';
    const detected = detectOffers(rawText);

    // Si no detecta nada, mantén solo chip (se añadirá en buildSpeech)
    const detectedFinal = detected.length ? detected : [];

    // Construir speech
    const finalHtml = buildSpeech('titular', detectedFinal);

    // Renderizar etiquetas (lo detectado por la página)
    const tags = (detectedFinal.length ? detectedFinal.map(d=>`✅ ${d.label}`) : []).concat(['✅ Chip S/1']).map(t=>`<span class="tag">${t}</span>`).join('');
    document.getElementById('detected-tags').innerHTML = tags;

    // Mostrar speech
    document.getElementById('speech-text-titular').innerHTML = finalHtml;
    document.getElementById('output-titular').style.display = 'block';
}


</script>
</body>
</html>

